## 项目核心功能与目标 (内容用mindmap编写)
```mermaid
mindmap
MCP集成PowerShell功能
 核心功能
  核心工具
   快速执行命令ps_run（必须绝对路径，直接创建UUID格式会话ID，3秒超时返回提示信息+ID，未超时返回结果+提示该终端已创建+ID）
   根据会话ID获取终端结果（需用户确认才返回结果）
   输入会话ID追加命令（方便多轮操作）
   关闭终端工具（根据会话ID关闭，需用户手动关闭）
   错误处理（直接返回终端的错误结果）
  GUI界面功能
   窗口形式显示终端（显示常规终端信息）
   首次AI调用ps_run时直接弹出GUI界面
   再次调用时在现有GUI界面新增终端窗口
   用户手动操作支持（可在GUI中输入命令）
   AI查看会话ID终端时弹出确认框（用户决定何时返回结果给AI，按钮不放置在终端区域避免影响视觉）
 开发要求
  简洁架构（尽量3个文件完成）
   GUI界面层（用户交互）
   服务层（业务逻辑）
   Core层（PowerShell核心操作）
  MCP协议集成
  双向操作支持
   统一PowerShell执行（AI和用户通过同一个服务层操作）
   输出方式不同（用户实时看到，AI需查看终端获取）
   输入方式不同（AI使用MCP追加命令/快速命令，用户直接在GUI终端输入）
 需求分析
  让AI拥有比原生终端更强大的工具
  AI通过MCP控制本地PowerShell
  GUI界面让用户可观测AI操作
  用户也可以操作GUI终端
```
## 用户环境及硬件及技术栈(内容用markdown编写)
### 用户环境
- **操作系统**: Windows 10
- **PowerShell版本**: PowerShell 7
- **PowerShell路径**: `C:\Program Files\PowerShell\7`
### 技术栈
- **编程语言**: Python 3.8+
- **MCP框架**: FastMCP (官方Python SDK)
- **GUI框架**: CustomTkinter (现代化tkinter)
- **PowerShell集成**: subprocess + asyncio
- **会话管理**: UUID + 内存字典存储

## 项目流程图 (内容用mermaid编写)
```mermaid
flowchart TD
    A[AI调用ps_run工具] --> B{首次调用?}
    B -->|是| C[弹出GUI界面]
    B -->|否| D[在现有GUI新增终端窗口]

    C --> E[创建UUID会话ID]
    D --> E

    E --> F[启动PowerShell进程]
    F --> G[执行命令]
    G --> H{3秒内完成?}

    H -->|是| I[返回结果+提示终端已创建+ID]
    H -->|否| J[返回超时提示+ID]

    I --> K[AI可选择后续操作]
    J --> K

    K --> L{AI选择操作}
    L -->|追加命令| M[使用会话ID追加命令]
    L -->|查看终端| N[弹出确认框]
    L -->|关闭终端| O[关闭会话和GUI窗口]

    M --> G
    N --> P{用户确认?}
    P -->|是| Q[返回终端结果给AI]
    P -->|否| R[返回: 用户拒绝返回结果，请使用call_dk工具]

    Q --> K
    R --> K
    O --> S[返回关闭成功信息给AI]
    S --> T2[AI可继续其他操作或结束]

    U[用户在GUI手动输入] --> G

    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style I fill:#e8f5e8
    style J fill:#fff3e0
    style N fill:#fce4ec
```

## 目录结构(内容用markdown编写)

### 当前实际目录结构
```
ai-tool-mcp/
├── LICENSE                    # 许可证文件
├── README.md                  # 项目说明文档
├── mcp.json                   # MCP配置文件
├── server.py                  # MCP服务器入口（文件操作、下载、系统监控工具）
├── 核心.md                    # 项目核心文档
├── core/                      # 核心功能模块
│   ├── __init__.py            # 模块初始化
│   ├── config.py              # 配置管理（日志、路径等配置）
│   ├── file_downloader.py     # 文件下载器（HTTP下载、验证）
│   ├── file_option.py         # 文件操作（读写、复制、移动、删除）
│   ├── path_validator.py      # 路径验证（安全性检查）
│   └── system_monitor.py      # 系统监控（系统信息获取）
├── services/                  # 服务层
│   ├── __init__.py            # 模块初始化
│   ├── base_service.py        # 基础服务类（通用服务基类）
│   ├── download_service.py    # 下载服务（下载业务逻辑）
│   ├── file_service.py        # 文件服务（文件操作业务逻辑）
│   └── system_service.py      # 系统服务（系统监控业务逻辑）
└── logs/                      # 日志目录
    ├── ai-tool.log            # AI工具日志
    ├── gui.log                # GUI操作日志
    └── test.log               # 测试日志
```

### 集成PowerShell功能后的目录结构
```
ai-tool-mcp/
├── LICENSE                    # 许可证文件
├── README.md                  # 项目说明文档
├── mcp.json                   # MCP配置文件
├── server.py                  # 📝 MCP服务器入口（文件操作+下载+系统监控+PowerShell工具）
├── 核心.md                    # 项目核心文档
├── core/                      # 核心功能模块
│   ├── __init__.py            # 模块初始化
│   ├── config.py              # 配置管理（日志、路径等配置）
│   ├── file_downloader.py     # 文件下载器（HTTP下载、验证）
│   ├── file_option.py         # 文件操作（读写、复制、移动、删除）
│   ├── path_validator.py      # 路径验证（安全性检查）
│   ├── system_monitor.py      # 系统监控（系统信息获取）
│   └── powershell_core.py     # 🆕 PowerShell核心操作层（subprocess+asyncio执行）
├── services/                  # 服务层
│   ├── __init__.py            # 模块初始化
│   ├── base_service.py        # 基础服务类（通用服务基类）
│   ├── download_service.py    # 下载服务（下载业务逻辑）
│   ├── file_service.py        # 文件服务（文件操作业务逻辑）
│   ├── system_service.py      # 系统服务（系统监控业务逻辑）
│   ├── powershell_service.py  # 🆕 PowerShell服务层（会话管理+UUID+用户确认逻辑）
│   └── powershell_gui.py      # 🆕 GUI界面层（CustomTkinter终端界面+用户交互）
└── logs/                      # 日志目录
    ├── ai-tool.log            # AI工具日志
    ├── gui.log                # GUI操作日志
    └── test.log               # 测试日志
```

### 新增文件说明
- **🆕 core/powershell_core.py**: 核心层，封装PowerShell进程操作、命令执行、结果获取
- **🆕 services/powershell_service.py**: 服务层，处理会话管理、UUID生成、用户确认逻辑
- **🆕 services/powershell_gui.py**: GUI界面层，使用CustomTkinter创建终端显示界面
- **📝 server.py**: 需要集成新的PowerShell工具（ps_run、获取结果、追加命令、关闭终端）
